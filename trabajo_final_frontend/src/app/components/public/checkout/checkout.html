<div class="container py-5">
  <div class="row">
    <!-- Columna Formulario -->
    <div class="col-md-7">
      <h2>Checkout</h2>
      <form [formGroup]="checkoutForm" (ngSubmit)="finalizarPedido()">
        <h4>Información de envío</h4>
        <div class="mb-3">
          <label>Nombre completo</label>
          <input class="form-control" formControlName="fullName" required>
          @if (checkoutForm.get('fullName')?.touched && checkoutForm.get('fullName')?.invalid) {
            <div class="text-danger small">
              @if (checkoutForm.get('fullName')?.errors?.['required']) {
                <div>El nombre es obligatorio.</div>
              }
              @if (checkoutForm.get('fullName')?.errors?.['minlength']) {
                <div>Debe tener al menos 3 caracteres.</div>
              }
              @if (checkoutForm.get('fullName')?.errors?.['pattern']) {
                <div>Solo letras y espacios.</div>
              }
              @if (checkoutForm.get('fullName')?.errors?.['sinPrimerLetraMayuscula']) {
                <div>La primera letra debe ser mayúscula.</div>
              }
            </div>
          }
        </div>
        <div class="mb-3">
          <label>Dirección</label>
          <input class="form-control" formControlName="address" required>
          @if (checkoutForm.get('address')?.touched && checkoutForm.get('address')?.invalid) {
            <div class="text-danger small">
              @if (checkoutForm.get('address')?.errors?.['required']) {
                <div>La dirección es obligatoria.</div>
              }
              @if (checkoutForm.get('address')?.errors?.['minlength']) {
                <div>Debe tener al menos 5 caracteres.</div>
              }
            </div>
          }
        </div>
        <div class="row">
          <div class="col">
            <label>Ciudad</label>
            <input class="form-control" formControlName="city" required>
            @if (checkoutForm.get('city')?.touched && checkoutForm.get('city')?.invalid) {
              <div class="text-danger small">
                @if (checkoutForm.get('city')?.errors?.['required']) {
                  <div>La ciudad es obligatoria.</div>
                }
                @if (checkoutForm.get('city')?.errors?.['minlength']) {
                  <div>Debe tener al menos 3 caracteres.</div>
                }
                @if (checkoutForm.get('city')?.errors?.['pattern']) {
                  <div>Solo letras y espacios.</div>
                }
              </div>
            }
          </div>
          <div class="col">
            <label>Código postal</label>
            <input class="form-control" formControlName="zip" required>
            @if (checkoutForm.get('zip')?.touched && checkoutForm.get('zip')?.invalid) {
              <div class="text-danger small">
                @if (checkoutForm.get('zip')?.errors?.['required']) {
                  <div>El código postal es obligatorio.</div>
                }
                @if (checkoutForm.get('zip')?.errors?.['pattern']) {
                  <div>Debe ser numérico (4 a 10 dígitos).</div>
                }
              </div>
            }
          </div>
        </div>
        <div class="mb-3 mt-3">
          <label>Email</label>
          <input class="form-control" formControlName="email" required>
          @if (checkoutForm.get('email')?.touched && checkoutForm.get('email')?.invalid) {
            <div class="text-danger small">
              @if (checkoutForm.get('email')?.errors?.['required']) {
                <div>El email es obligatorio.</div>
              }
              @if (checkoutForm.get('email')?.errors?.['email']) {
                <div>Formato de email inválido.</div>
              }
              @if (checkoutForm.get('email')?.errors?.['emailInvalido']) {
                <div>Email inválido.</div>
              }
            </div>
          }
        </div>
        <h4>Información de pago</h4>
        <div class="mb-3">
          <button type="button" (click)="pagarConQR()" [disabled]="cartItems.length === 0 || !camposEnvioValidos()">
            Pagar con QR
          </button>
          @if (mostrarQR) {
            <app-qr-payment
              [amount]="total"
              [description]="'Pago de pedido'"
              (pagoExitoso)="finalizarPedido()"
              (pagoFallido)="onPagoFallido()">
            </app-qr-payment>
          }
        </div>
        <button class="btn btn-primary w-100 mt-4" type="submit" [disabled]="checkoutForm.invalid">Realizar pedido</button>
        <button type="button" (click)="verEstadoFormulario()">Ver estado formulario</button>
      </form>
    </div>
    <!-- Columna Resumen Carrito -->
    <div class="col-md-5">
      <h4>Resumen del pedido</h4>
      @if (cartItems.length === 0) {
        <div class="text-center py-5">
          <i class="fas fa-shopping-cart" style="font-size: 3rem; color: #638288;"></i>
          <h5 class="fw-bold mt-3">Tu carrito está vacío</h5>
          <p class="text-muted">¡Agrega algunos productos increíbles!</p>
        </div>
      }
      @if (cartItems.length > 0) {
        <div>
          @for (item of cartItems; track trackByItem($index, item)) {
            <div class="d-flex align-items-center mb-3 border-bottom pb-2">
              <div>
                @if (item.producto.imagenes && item.producto.imagenes.length > 0) {
                  <img [src]="item.producto.imagenes[0]" class="rounded me-3" width="60" height="60" [alt]="item.producto.nombre">
                } @else {
                  <span class="d-inline-flex align-items-center justify-content-center rounded me-3" style="width:60px;height:60px;background:#f0f0f0;">
                    <i class="fas fa-image text-muted" style="font-size:2.5rem;"></i>
                  </span>
                }
              </div>
              <div class="flex-grow-1">
                <div class="fw-medium">{{item.producto.nombre}}</div>
                <div class="mt-1">
                  <span class="me-2">Cantidad:</span>
                  <span class="fw-bold">{{item.cantidad}}</span>
                </div>
              </div>
              <div class="fw-bold ms-2">{{formatearMoneda(item.producto.precio * item.cantidad)}}</div>
            </div>
          }
        </div>
        <form (ngSubmit)="applyCoupon()" class="input-group mb-3">
          <input type="text" class="form-control" placeholder="Cupón" [(ngModel)]="couponCode" name="couponCode">
          <button class="btn btn-outline-secondary" type="submit">Aplicar</button>
        </form>
        @if (couponMessage) {
          <div class="alert alert-info py-1">{{couponMessage}}</div>
        }
        <ul class="list-group mb-3">
          @if (descuento>0) {
            <li class="list-group-item d-flex justify-content-between">
              <span>Descuento cupón ({{descuentoPorcentaje}}%)</span>
              <span class="text-success">-{{formatearMoneda(descuento)}}</span>
            </li>
          }
          <li class="list-group-item d-flex justify-content-between">
            <span>Subtotal</span>
            <span>{{formatearMoneda(subtotal)}}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Envío</span>
            <span>{{shipping}}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Impuestos</span>
            <span>{{formatearMoneda(tax)}}</span>
          </li>
          <li class="list-group-item d-flex justify-content-between fw-bold">
            <span>Total</span>
            <span>{{formatearMoneda(total)}}</span>
          </li>
        </ul>
      }
    </div>
  </div>
</div>
